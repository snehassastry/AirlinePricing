<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Airline Overbooking Optimization</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #eaf3fc;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 1000px;
      margin: 40px auto;
      background-color: white;
      padding: 30px 50px;
      border-radius: 14px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
    }

    h2 {
      text-align: center;
      color: #2c3e50;
      margin-bottom: 25px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 260px 180px 260px 180px;
      gap: 10px 10px;
      align-items: center;
    }

    label {
      font-weight: 500;
      color: #333;
      text-align: right;
      margin-right: 8px;
    }

    input,
    select {
      padding: 7px 9px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 6px;
      width: 100%;
      box-sizing: border-box;
    }

    button {
      margin-top: 25px;
      width: 100%;
      padding: 12px;
      background-color: #007BFF;
      color: white;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    button:hover {
      background-color: #0056b3;
    }

    .results, .log-box {
      margin-top: 30px;
      padding: 20px;
      background-color: #f1f8ff;
      border-radius: 10px;
    }

    .log-box {
      background-color: #fffbe6;
      border: 1px solid #f0e6a6;
      font-family: monospace;
      white-space: pre-wrap;
    }

    table.summary-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 30px;
    }

    table.summary-table th, td {
      border: 1px solid #ddd;
      padding: 8px;
    }

    table.summary-table th {
      background-color: #007BFF;
      color: white;
    }

    img.plot {
      max-width: 100%;
      border-radius: 8px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>‚úàÔ∏è Airline Overbooking Optimization</h2>
    <form id="main-form">
      <div class="form-grid">
        {% macro val(name) -%}{{ form_values.get(name, '') }}{%- endmacro %}
        {% set required = 'required' %}

        <label>Days to Departure</label>
        <input name="time_steps" type="number" {{ required }} value="{{ val('time_steps') }}">
        <label>Discount Rate</label>
        <input name="discount" type="text" {{ required }} value="{{ val('discount') }}">

        <label>Coach Seats</label>
        <input name="n_seats_coach" type="number" {{ required }} value="{{ val('n_seats_coach') }}">
        <label>Overbooking Limit</label>
        <input name="overbook_coach" type="number" {{ required }} value="{{ val('overbook_coach') }}">

        <label>Coach Price (High)</label>
        <input name="price_coach_high" type="number" {{ required }} value="{{ val('price_coach_high') }}">
        <label>Sell Probability</label>
        <input name="prob_coach_high" type="text" {{ required }} value="{{ val('prob_coach_high') }}">

        <label>Coach Price (Low)</label>
        <input name="price_coach_low" type="number" {{ required }} value="{{ val('price_coach_low') }}">
        <label>Sell Probability</label>
        <input name="prob_coach_low" type="text" {{ required }} value="{{ val('prob_coach_low') }}">

        <label>Coach Showup Prob.</label>
        <input name="showup_prob_coach" type="text" {{ required }} value="{{ val('showup_prob_coach') }}">
        <label>First Class Showup Prob.</label>
        <input name="showup_prob_first" type="text" {{ required }} value="{{ val('showup_prob_first') }}">

        <label>First Class Seats</label>
        <input name="n_seats_first" type="number" {{ required }} value="{{ val('n_seats_first') }}">
        <div></div><div></div>

        <label>First Class Price (High)</label>
        <input name="price_first_high" type="number" {{ required }} value="{{ val('price_first_high') }}">
        <label>Sell Probability</label>
        <input name="prob_first_high" type="text" {{ required }} value="{{ val('prob_first_high') }}">

        <label>First Class Price (Low)</label>
        <input name="price_first_low" type="number" {{ required }} value="{{ val('price_first_low') }}">
        <label>Sell Probability</label>
        <input name="prob_first_low" type="text" {{ required }} value="{{ val('prob_first_low') }}">

        <label>If First Class is filled,Boost Coach Buy (%)</label>
        <input name="coach_price_boost" type="text" {{ required }} value="{{ val('coach_price_boost') }}">
        <div></div><div></div>

        <label>Upgrade Cost</label>
        <input name="cost_upgrade" type="text" {{ required }} value="{{ val('cost_upgrade') }}">
        <label>Deboard Cost</label>
        <input name="cost_off" type="text" {{ required }} value="{{ val('cost_off') }}">

        <label>Seasonality</label>
        <select name="apply_seasonality" {{ required }}>
          <option value="True" {% if form_values.get('apply_seasonality') == 'True' %}selected{% endif %}>True</option>
          <option value="False" {% if form_values.get('apply_seasonality') == 'False' %}selected{% endif %}>False</option>
        </select>

        <label>Option to Not Sell Coach</label>
        <select name="has_option_to_not_sell" {{ required }}>
          <option value="True" {% if form_values.get('has_option_to_not_sell') == 'True' %}selected{% endif %}>True</option>
          <option value="False" {% if form_values.get('has_option_to_not_sell') == 'False' %}selected{% endif %}>False</option>
        </select>
      </div>

      <button type="submit">Render Results üìä</button>
    </form>

    {% if summary_table %}
      <div class="results">
        <h3>üìã Input Summary</h3>
        {{ summary_table | safe }}
      </div>
    {% endif %}

    <div class="log-box" id="progress-log"></div>
  </div>

  <script>
    const form = document.getElementById('main-form');
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      const formData = new FormData(form);
      const logBox = document.getElementById('progress-log');
      logBox.innerHTML = ''; // Clear previous output

      fetch('/stream', {
        method: 'POST',
        body: formData,
      }).then(response => {
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let content = '';

        function read() {
          reader.read().then(({ done, value }) => {
            if (done) return;
            const chunk = decoder.decode(value);
            content += chunk;
            const cleaned = chunk.replace(/^data: /gm, '').replace(/\\n/g, '');
            logBox.innerHTML += cleaned;
            read();
          });
        }

        read();
      });
    });
  </script>
</body>
</html>
